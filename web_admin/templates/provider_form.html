{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1>
                    <i class="bi bi-plug"></i> 
                    {% if provider %}Edit Provider{% else %}Add New Provider{% endif %}
                </h1>
                <a href="{{ url_for('web_admin.providers_list') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Providers
                </a>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear"></i> Provider Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Provider Name *</label>
                                    <input type="text" class="form-control" id="name" name="name" 
                                           value="{{ provider.name if provider else '' }}" required>
                                    <div class="invalid-feedback">
                                        Please enter a provider name.
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="api_endpoint" class="form-label">API Endpoint *</label>
                                    <input type="url" class="form-control" id="api_endpoint" name="api_endpoint" 
                                           value="{{ provider.api_endpoint if provider else '' }}" required>
                                    <div class="invalid-feedback">
                                        Please enter a valid API endpoint URL.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="api_key" class="form-label">API Key *</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="api_key" name="api_key" 
                                               value="{{ provider.api_key if provider else '' }}" required>
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="togglePasswordVisibility('api_key')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">
                                        Please enter an API key.
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="default_model" class="form-label">Default Model</label>
                                    <input type="text" class="form-control" id="default_model" name="default_model" 
                                           value="{{ provider.default_model if provider else '' }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="auth_method" class="form-label">Authentication Method</label>
                                    <select class="form-select" id="auth_method" name="auth_method">
                                        <option value="bearer_token" {% if provider and provider.auth_method == 'bearer_token' %}selected{% endif %}>Bearer Token</option>
                                        <option value="basic_auth" {% if provider and provider.auth_method == 'basic_auth' %}selected{% endif %}>Basic Authentication</option>
                                        <option value="custom_header" {% if provider and provider.auth_method == 'custom_header' %}selected{% endif %}>Custom Header</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="api_standard" class="form-label">API Standard</label>
                                    <select class="form-select" id="api_standard" name="api_standard">
                                        <option value="openai" {% if provider and provider.api_standard == 'openai' %}selected{% endif %}>OpenAI Compatible</option>
                                        <option value="anthropic" {% if provider and provider.api_standard == 'anthropic' %}selected{% endif %}>Anthropic Compatible</option>
                                        <option value="grok" {% if provider and provider.api_standard == 'grok' %}selected{% endif %}>Grok Format</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                           {% if provider and provider.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="is_active">
                                        Active Provider
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h5>
                                <i class="bi bi-diagram-3"></i> Model Mapping
                            </h5>
                            <hr>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="model_haiku" class="form-label">Haiku Equivalent</label>
                                        <input type="text" class="form-control" id="model_haiku" name="model_haiku" 
                                               placeholder="e.g., claude-3-haiku-20240307" 
                                               value="{{ provider.model_mapping.haiku if provider and provider.model_mapping else '' }}">
                                        <small class="form-text text-muted">
                                            Model equivalent to Claude 3 Haiku
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="model_sonnet" class="form-label">Sonnet Equivalent</label>
                                        <input type="text" class="form-control" id="model_sonnet" name="model_sonnet" 
                                               placeholder="e.g., claude-3-5-sonnet-20241022" 
                                               value="{{ provider.model_mapping.sonnet if provider and provider.model_mapping else '' }}">
                                        <small class="form-text text-muted">
                                            Model equivalent to Claude 3.5 Sonnet
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="model_opus" class="form-label">Opus Equivalent</label>
                                        <input type="text" class="form-control" id="model_opus" name="model_opus" 
                                               placeholder="e.g., claude-3-opus-20240229" 
                                               value="{{ provider.model_mapping.opus if provider and provider.model_mapping else '' }}">
                                        <small class="form-text text-muted">
                                            Model equivalent to Claude 3 Opus
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h5>
                                <i class="bi bi-list"></i> Custom Headers
                            </h5>
                            <hr>
                            
                            <div id="headers-container">
                                {% if provider and provider.headers %}
                                    {% for key, value in provider.headers.items() %}
                                    <div class="row mb-2 header-row">
                                        <div class="col-md-5">
                                            <input type="text" class="form-control header-key" name="header_key[]" placeholder="Header Name" value="{{ key }}">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control header-value" name="header_value[]" placeholder="Header Value" value="{{ value }}">
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeHeader(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                <div class="row mb-2 header-row">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control header-key" name="header_key[]" placeholder="Header Name">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control header-value" name="header_value[]" placeholder="Header Value">
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeHeader(this)" disabled>
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addHeader()">
                                <i class="bi bi-plus-circle"></i> Add Header
                            </button>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <div>
                                {% if provider %}
                                <a href="{{ url_for('web_admin.provider_delete', provider_id=provider.id) }}" 
                                   class="btn btn-danger" 
                                   onclick="return confirm('Are you sure you want to delete this provider?')">
                                    <i class="bi bi-trash"></i> Delete Provider
                                </a>
                                {% endif %}
                            </div>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> 
                                    {% if provider %}Update Provider{% else %}Save Provider{% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle"></i> Provider Information
                    </h5>
                </div>
                <div class="card-body">
                    <h6>Common Provider Endpoints:</h6>
                    <ul>
                        <li><strong>OpenRouter</strong>: <code>https://openrouter.ai/api/v1</code></li>
                        <li><strong>Chutes</strong>: <code>http://llm.chutes.ai/api/v1</code></li>
                        <li><strong>Synthetic</strong>: <code>https://api.synthetic.new/v1</code></li>
                        <li><strong>AIML</strong>: <code>https://api.aimlapi.com/v1</code></li>
                        <li><strong>Grok (Direct)</strong>: <code>https://api.x.ai/v1</code></li>
                        <li><strong>Grok (OpenAI)</strong>: <code>https://api.x.ai/v1</code></li>
                    </ul>
                    
                    <h6 class="mt-3">Authentication Methods:</h6>
                    <ul>
                        <li><strong>Bearer Token</strong>: Standard API key in Authorization header</li>
                        <li><strong>Basic Auth</strong>: Username/password in Authorization header</li>
                        <li><strong>Custom Header</strong>: API key in custom header</li>
                    </ul>
                    
                    <h6 class="mt-3">API Standards:</h6>
                    <ul>
                        <li><strong>OpenAI Compatible</strong>: OpenAI format (chat/completions)</li>
                        <li><strong>Anthropic Compatible</strong>: Anthropic format (messages)</li>
                        <li><strong>Grok Format</strong>: xAI's custom format</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addHeader() {
    const container = document.getElementById('headers-container');
    const newRow = document.createElement('div');
    newRow.className = 'row mb-2 header-row';
    newRow.innerHTML = `
        <div class="col-md-5">
            <input type="text" class="form-control header-key" name="header_key[]" placeholder="Header Name">
        </div>
        <div class="col-md-6">
            <input type="text" class="form-control header-value" name="header_value[]" placeholder="Header Value">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeHeader(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(newRow);
}

function removeHeader(button) {
    const row = button.closest('.header-row');
    if (row) {
        row.remove();
    }
}

function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = field.nextElementSibling.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for password visibility toggles
    const toggleButtons = document.querySelectorAll('[onclick*="togglePasswordVisibility"]');
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const fieldId = this.getAttribute('onclick').match(/togglePasswordVisibility\('(.+?)'\)/)[1];
            togglePasswordVisibility(fieldId);
        });
    });
});
</script>
{% endblock %}